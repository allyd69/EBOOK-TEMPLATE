<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pro-Ebook — Prototypes (Category Templates + EPUB)</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Montserrat:wght@400;600;700;800&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://unpkg.com/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
:root{
  --color-primary:#8b4789; --color-secondary:#d4a373; --color-accent:#2f5d62;
  --cover-font: 'Cormorant Garamond', serif; --body-font:'Crimson Text', serif;
}
*{box-sizing:border-box}
body{font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background:linear-gradient(135deg,#1f2421 0%,#2f3e46 100%); color:#222; padding:18px;}
.container{max-width:1100px;margin:0 auto;background:rgba(255,255,255,0.03);padding:18px;border-radius:12px;}
.header{color:#fff;text-align:center;margin-bottom:12px}
.header h1{font-family:var(--cover-font);font-size:30px;background:linear-gradient(90deg,var(--color-secondary),var(--color-primary));-webkit-background-clip:text;color:transparent;margin:0}
.header p{opacity:.85;font-size:13px;margin-top:6px}
.panel{background:white;padding:14px;border-radius:10px;margin-bottom:12px;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;font-size:14px}
.textarea{min-height:80px;resize:vertical}
.row{display:flex;gap:8px;align-items:center}
.btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn-primary{background:linear-gradient(90deg,var(--color-primary),var(--color-secondary));color:white}
.btn-ghost{background:#f3f3f3;border:1px solid #ddd}
.previewWrap{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
.page{width:600px;height:800px;background:white;border-radius:8px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,.35);display:none}
.page.active{display:block}
.cover{padding:60px 48px;display:flex;flex-direction:column;height:100%;justify-content:center;color:#fff}
.content{padding:48px;background:#fbf6ef;height:100%;overflow:auto}
.content h2{font-family:var(--cover-font);color:var(--color-primary);font-size:32px}
.content p{font-family:var(--body-font);line-height:1.75;color:#333}
.thumbRow{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.thumb{width:90px;height:64px;object-fit:cover;border-radius:8px;border:2px solid #eee;cursor:pointer;position:relative}
.focalDot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.95);border:2px solid var(--color-primary);position:absolute;transform:translate(-50%,-50%);pointer-events:none}
.small{font-size:13px;color:#555}
.notice{background:#fffbe6;padding:8px;border-radius:8px;border:1px solid #f1dca6;margin-top:8px}
.footer{margin-top:12px;color:#dcdcdc;font-size:13px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Pro-Ebook</h1>
    <p>Category-driven templates · Upload text + images · Recreate until perfect · Export PDF & EPUB</p>
  </div>

  <!-- Metadata & Category -->
  <div class="panel grid">
    <div>
      <label class="small">Book Title</label>
      <input id="bookTitle" class="input" value="The Renaissance Mind">
    </div>
    <div>
      <label class="small">Subtitle</label>
      <input id="subtitle" class="input" value="Cultivating Wisdom in the Modern Age">
    </div>
    <div>
      <label class="small">Author</label>
      <input id="authorName" class="input" value="Dr. Sophia Montenegro">
    </div>
    <div>
      <label class="small">Category (this controls style)</label>
      <select id="category" class="input">
        <option value="">-- Choose a category --</option>
        <option value="business">Business / Entrepreneurship</option>
        <option value="selfhelp">Self-help / Personal growth</option>
        <option value="memoir">Memoir / Narrative nonfiction</option>
        <option value="tech">Tech / How-to</option>
        <option value="cookbook">Cookbooks / Lifestyle</option>
        <option value="design">Design / Artbooks</option>
        <option value="children">Children’s / Short reads</option>
      </select>
    </div>
    <div>
      <label class="small">ISBN (optional)</label>
      <input id="isbn" class="input">
    </div>
    <div>
      <label class="small">Use Roman numerals for front matter</label>
      <div class="row"><input id="useRoman" type="checkbox" checked> <span class="small" style="margin-left:8px">Yes</span></div>
    </div>
  </div>

  <!-- Uploads -->
  <div class="panel grid">
    <div>
      <label class="small">Upload Text (DOCX / MD / TXT)</label>
      <input id="textUpload" type="file" accept=".docx,.md,.txt,.rtf,.pdf">
      <div class="notice small">Tip: DOCX or Markdown gives best results for headings & TOC.</div>
    </div>
    <div>
      <label class="small">Upload Images (JPG / PNG / WEBP / SVG)</label>
      <input id="imagesUpload" type="file" accept="image/*" multiple>
      <div id="thumbRow" class="thumbRow"></div>
      <div class="small" style="margin-top:6px">
        <label><input id="coverOnly" type="checkbox"> Use images for cover only</label>
        &nbsp;&nbsp;
        <label><input name="placement" value="auto" type="radio" checked> Auto-place</label>
        <label><input name="placement" value="manual" type="radio"> Manual place (composer later)</label>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="panel row" style="justify-content:space-between;align-items:center">
    <div class="row" style="gap:8px">
      <button class="btn btn-primary" id="updateBtn">Update Preview</button>
      <button class="btn btn-ghost" id="recreateBtn">Recreate Template</button>
      <button class="btn btn-ghost" id="publishBtn">Publish (Save Template)</button>
    </div>

    <div class="row" style="gap:8px">
      <button class="btn btn-ghost" id="exportPdfBtn">Export PDF</button>
      <button class="btn btn-ghost" id="exportEpubBtn">Export EPUB</button>
    </div>
  </div>

  <!-- Preview -->
  <div id="previewArea" class="panel">
    <div id="previewContainer" class="previewWrap"></div>
  </div>

  <div class="footer">Pro-Ebook prototype — client-side MVP; saves published templates in your browser (localStorage).</div>
</div>

<script>
/* -------------------------
   State & utilities
   ------------------------- */
let currentTemplate = 'ethereal';
let currentPalette = {primary:'#8b4789', secondary:'#d4a373', accent:'#2f5d62'};
let currentFonts = {cover:'Cormorant Garamond', body:'Crimson Text'};
let parsedText = '';
let chapters = []; // strings
let images = []; // {file, url, focal:{x,y}}
const previewContainer = document.getElementById('previewContainer');
const thumbRow = document.getElementById('thumbRow');

/* Category mapping */
const categoryRules = {
  business: {palette:{primary:'#0b4f6c',secondary:'#a2d2ff',accent:'#084c61'}, fonts:{cover:'Montserrat',body:'Crimson Text'}},
  selfhelp:{palette:{primary:'#8b4789',secondary:'#f5a962',accent:'#2f5d62'}, fonts:{cover:'Cormorant Garamond',body:'Crimson Text'}},
  memoir:{palette:{primary:'#6a3f5a',secondary:'#cba58a',accent:'#4a4a4a'}, fonts:{cover:'Cormorant Garamond',body:'Crimson Text'}},
  tech:{palette:{primary:'#0b3d91',secondary:'#7fb3ff',accent:'#102a43'}, fonts:{cover:'Montserrat',body:'Crimson Text'}},
  cookbook:{palette:{primary:'#b23a2a',secondary:'#f5d4a4',accent:'#6b2d1a'}, fonts:{cover:'Montserrat',body:'Crimson Text'}},
  design:{palette:{primary:'#2b2d42',secondary:'#8d99ae',accent:'#ef233c'}, fonts:{cover:'Cormorant Garamond',body:'Crimson Text'}},
  children:{palette:{primary:'#ff7b7b',secondary:'#ffd6a5',accent:'#a0e7e5'}, fonts:{cover:'Montserrat',body:'Crimson Text'}},
  default:{palette:{primary:'#8b4789',secondary:'#d4a373',accent:'#2f5d62'}, fonts:{cover:'Cormorant Garamond',body:'Crimson Text'}}
};

function applyCategory() {
  const cat = document.getElementById('category').value || 'default';
  const rule = categoryRules[cat]||categoryRules.default;
  currentPalette = rule.palette; currentFonts = rule.fonts;
  document.documentElement.style.setProperty('--color-primary', currentPalette.primary);
  document.documentElement.style.setProperty('--color-secondary', currentPalette.secondary);
  document.documentElement.style.setProperty('--color-accent', currentPalette.accent);
  document.documentElement.style.setProperty('--cover-font', currentFonts.cover);
  document.documentElement.style.setProperty('--body-font', currentFonts.body);
}

/* -------------------------
   Image upload + thumbs + focal selection
   ------------------------- */
document.getElementById('imagesUpload').addEventListener('change', function(e){
  const files = Array.from(e.target.files || []);
  images = files.map(f => ({file:f, url:URL.createObjectURL(f), focal:{x:50,y:50}}));
  renderThumbs();
});

function renderThumbs(){
  thumbRow.innerHTML = '';
  images.forEach((img, idx) => {
    const el = document.createElement('div'); el.style.position='relative';
    const node = document.createElement('img'); node.src = img.url; node.className='thumb';
    node.addEventListener('click', (ev)=>{
      // set focal point relative to element
      const rect = node.getBoundingClientRect();
      const x = ((ev.clientX - rect.left)/rect.width)*100;
      const y = ((ev.clientY - rect.top)/rect.height)*100;
      images[idx].focal = {x:Math.round(x), y:Math.round(y)};
      renderThumbs();
    });
    el.appendChild(node);
    // show focal dot
    const dot = document.createElement('div'); dot.className='focalDot';
    dot.style.left = (img.focal.x/100*90)+'px'; dot.style.top = (img.focal.y/100*60)+'px';
    el.appendChild(dot);
    thumbRow.appendChild(el);
  });
}

/* -------------------------
   Text upload & parsing
   ------------------------- */
document.getElementById('textUpload').addEventListener('change', async function(e){
  const file = e.target.files[0]; if(!file) return;
  const ext = (file.name.split('.').pop()||'').toLowerCase();
  parsedText = '';
  document.getElementById('updateBtn').textContent = 'Parsing...';
  try {
    if(ext === 'docx'){
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.convertToHtml({arrayBuffer});
      parsedText = result.value || '';
    } else if(ext === 'md'){
      const text = await file.text();
      parsedText = marked.parse(text);
    } else {
      // txt or fallback
      const txt = await file.text();
      parsedText = '<p>' + txt.replace(/\n{2,}/g,'</p><p>').replace(/\n/g,'<br/>') + '</p>';
    }
    detectChapters(parsedText);
  } catch(err){
    console.error(err); alert('Error parsing file');
  } finally {
    document.getElementById('updateBtn').textContent = 'Update Preview';
  }
});

/* Chapter detection: try headings, then Chapter X, then chunking */
function detectChapters(html){
  // strip tags to examine lines
  const plain = html.replace(/<[^>]+>/g,'\n').replace(/\r/g,'');
  // 1) markdown/heading-like '# ' or <h1> present: split by <h1> or by heading markers
  const byHtags = html.split(/<h[1-3][^>]*>|<\/h[1-3]>/i).filter(Boolean);
  // naive approach: if many heading markers exist, split by regex of common headings in plain
  const headingLines = plain.split('\n').map(l=>l.trim()).filter(Boolean).filter(l=>/^#{1,3}\s+/.test(l) || /^[A-Z0-9][\w\s-]{4,100}$/.test(l) && l===l.toUpperCase());
  if(headingLines.length>1){
    // split by "chapter-like" markers in original html
    const parts = html.split(/\n(?=<h[1-3])/i);
    chapters = parts.map(p=>p.trim()).filter(Boolean);
    return;
  }
  // 2) explicit "Chapter X"
  const chapSplit = plain.split(/\n+(?=chapter\s+\d+[\.:]?\s+)/i).map(s=>s.trim()).filter(Boolean);
  if(chapSplit.length>1){ chapters = chapSplit; return; }
  // 3) fallback: chunk by word count (~2500 words)
  const words = plain.split(/\s+/);
  if(words.length<2500){ chapters = [html]; return; }
  const chunkSize = 2500; let chunks=[]; for(let i=0;i<words.length;i+=chunkSize) chunks.push(words.slice(i,i+chunkSize).join(' '));
  chapters = chunks.map(c=>'<p>'+c.replace(/\n{2,}/g,'</p><p>')+'</p>');
}

/* -------------------------
   Preview rendering
   ------------------------- */
function updatePreview(){
  applyCategory();
  previewContainer.innerHTML = '';
  const title = document.getElementById('bookTitle').value;
  const subtitle = document.getElementById('subtitle').value;
  const author = document.getElementById('authorName').value;
  const useRoman = document.getElementById('useRoman').checked;
  // Cover page
  const cover = document.createElement('div'); cover.className='page active';
  const coverInner = document.createElement('div'); coverInner.className='cover';
  coverInner.style.background = `linear-gradient(135deg, ${currentPalette.primary}, ${currentPalette.secondary})`;
  const h1 = document.createElement('h1'); h1.style.fontFamily = currentFonts.cover; h1.style.fontSize='36px'; h1.textContent = title;
  const sub = document.createElement('div'); sub.className='small'; sub.textContent = subtitle; sub.style.margin='12px 0';
  const auth = document.createElement('div'); auth.style.marginTop='auto'; auth.textContent = author; auth.style.fontWeight='700';
  coverInner.appendChild(h1); coverInner.appendChild(sub); coverInner.appendChild(auth);
  cover.appendChild(coverInner);
  previewContainer.appendChild(cover);

  // TOC
  const toc = document.createElement('div'); toc.className='page';
  const tocInner = document.createElement('div'); tocInner.className='content';
  tocInner.innerHTML = `<h2>Contents</h2>`;
  const list = document.createElement('div'); list.className='small';
  // intro
  let pageIndex = 3;
  list.innerHTML += `<div>Introduction ..................................... ${pageIndex}</div>`;
  chapters.forEach((c, idx)=>{
    pageIndex++;
    // guess title for TOC (first line or Chapter X)
    const t = guessChapterTitle(c, idx);
    list.innerHTML += `<div>${t} ..................................... ${pageIndex}</div>`;
  });
  list.innerHTML += `<div>Conclusion ..................................... ${pageIndex+1}</div>`;
  tocInner.appendChild(list); toc.appendChild(tocInner); previewContainer.appendChild(toc);

  // Introduction page
  const introPage = document.createElement('div'); introPage.className='page';
  introPage.innerHTML = `<div class="content"><h2>Introduction</h2><p class="small">Auto-generated intro. Edit before final export if desired.</p><div class="page-number" style="position:absolute;right:30px;bottom:28px;color:${currentPalette.secondary};font-weight:700">3</div></div>`;
  previewContainer.appendChild(introPage);

  // Chapters
  const placementMode = document.querySelector('input[name="placement"]:checked').value;
  const coverOnly = document.getElementById('coverOnly').checked;
  chapters.forEach((c, idx) => {
    const page = document.createElement('div'); page.className='page';
    const content = document.createElement('div'); content.className='content';
    const title = guessChapterTitle(c, idx);
    content.innerHTML = `<h2>${title}</h2>${c.slice(0,1600)}${c.length>1600?'...':''}`;
    // image placement logic (auto)
    if(placementMode==='auto' && !coverOnly && images[idx]){
      const imgEl = document.createElement('img');
      imgEl.src = images[idx].url; imgEl.style.width='100%'; imgEl.style.marginTop='10px'; imgEl.style.objectFit='cover';
      const fx = images[idx].focal.x||50, fy = images[idx].focal.y||50;
      imgEl.style.objectPosition = `${fx}% ${fy}%`;
      content.insertBefore(imgEl, content.children[1] || content.firstChild.nextSibling);
    } else if(idx===0 && images.length>0 && !coverOnly){
      const imgEl = document.createElement('img'); imgEl.src = images[0].url; imgEl.style.width='100%'; imgEl.style.marginTop='10px';
      content.appendChild(imgEl);
    }
    // page number
    const pnum = document.createElement('div'); pnum.className='page-number';
    pnum.style.position='absolute'; pnum.style.right='40px'; pnum.style.bottom='28px'; pnum.style.color=currentPalette.secondary; pnum.style.fontWeight='700';
    pnum.textContent = (4+idx);
    page.appendChild(content); page.appendChild(pnum);
    previewContainer.appendChild(page);
  });

  // Conclusion & About
  const conclusion = document.createElement('div'); conclusion.className='page';
  conclusion.innerHTML = `<div class="content"><h2>Conclusion</h2><p>Thank you for reading — this is a preview. Final export will include full pages & TOC page numbers after layout.</p><div style="position:absolute;right:40px;bottom:28px;color:${currentPalette.secondary};font-weight:700">${4+chapters.length}</div></div>`;
  previewContainer.appendChild(conclusion);

  const about = document.createElement('div'); about.className='page';
  about.innerHTML = `<div class="content"><h2>About the Author</h2><p>${document.getElementById('authorName').value} — author bio goes here.</p><div style="position:absolute;right:40px;bottom:28px;color:${currentPalette.secondary};font-weight:700">${5+chapters.length}</div></div>`;
  previewContainer.appendChild(about);

  // ensure first page visible
  const pages = previewContainer.querySelectorAll('.page');
  pages.forEach(p=>p.classList.remove('active'));
  if(pages[0]) pages[0].classList.add('active');
}

/* guess title from a chunk */
function guessChapterTitle(chunk, i){
  // look for first heading-like line
  const tmp = chunk.replace(/<\/?[^>]+(>|$)/g, '\n').split('\n').map(s=>s.trim()).filter(Boolean);
  for(const l of tmp){
    if(/^chapter\s+\d+/i.test(l)) return l;
    if(l.length>3 && l.length<80 && l.split(' ').length<10) return l;
  }
  return 'Chapter ' + (i+1);
}

/* -------------------------
   Recreate template (palette jitter within category)
   ------------------------- */
document.getElementById('recreateBtn').addEventListener('click', () => {
  // Slight color jitter on primary using HSL shift
  const cat = document.getElementById('category').value || 'default';
  applyCategory(cat);
  // jitter function
  const jitterHex = (hex) => {
    const c = hexToRgb(hex); const jitter = ()=>Math.max(0,Math.min(255, c.r + Math.floor((Math.random()-0.5)*40)));
    return rgbToHex(jitter(), jitter(), jitter());
  };
  currentPalette.primary = jitterHex(currentPalette.primary);
  currentPalette.secondary = jitterHex(currentPalette.secondary);
  applyCategory();
  updatePreview();
});

/* apply category mapping when changed */
document.getElementById('category').addEventListener('change', ()=>applyCategory());
function applyCategory(){
  const cat = document.getElementById('category').value || 'default';
  const rule = categoryRules[cat] || categoryRules.default;
  currentPalette = rule.palette; currentFonts = rule.fonts;
  document.documentElement.style.setProperty('--color-primary', currentPalette.primary);
  document.documentElement.style.setProperty('--color-secondary', currentPalette.secondary);
  document.documentElement.style.setProperty('--color-accent', currentPalette.accent);
  // note: fonts are referenced in CSS via var; not switching actual fonts here to keep simplicity
}

/* -------------------------
   Publish (save derived template to localStorage)
   ------------------------- */
document.getElementById('publishBtn').addEventListener('click', ()=>{
  const snapshot = {
    meta:{title:document.getElementById('bookTitle').value, author:document.getElementById('authorName').value, category:document.getElementById('category').value, timestamp:Date.now()},
    template:{palette:currentPalette, fonts:currentFonts},
    content:{chaptersCount:chapters.length}
  };
  const key = 'proebook_template_' + Date.now();
  localStorage.setItem(key, JSON.stringify(snapshot));
  alert('Published snapshot saved locally ('+key+'). It is added to your derived templates in this browser.');
});

/* -------------------------
   Export PDF (client-side html2pdf)
   ------------------------- */
document.getElementById('exportPdfBtn').addEventListener('click', ()=>{
  // convert preview container to printable PDF
  const opt = { margin:0.6, filename: (document.getElementById('bookTitle').value || 'ebook') + '.pdf',
    image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'}};
  html2pdf().set(opt).from(previewContainer).save();
});

/* -------------------------
   Export EPUB (client-side: JSZip)
   Minimal EPUB 2.0 structure
   ------------------------- */
document.getElementById('exportEpubBtn').addEventListener('click', async ()=>{
  const title = document.getElementById('bookTitle').value || 'Untitled';
  const author = document.getElementById('authorName').value || '';
  const id = 'id-' + Date.now();
  const zip = new JSZip();

  // 1) mimetype (must be uncompressed and first entry ideally)
  zip.file('mimetype', 'application/epub+zip', {binary:false, compression: 'STORE'});

  // 2) META-INF/container.xml
  zip.file('META-INF/container.xml', `<?xml version="1.0"?>\n<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">\n  <rootfiles>\n    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>\n  </rootfiles>\n</container>`);

  // 3) OEBPS/ (css + text files)
  // stylesheet
  const css = `body{font-family:serif;margin:1.2em} h1{font-size:1.6em} h2{font-size:1.2em} img{max-width:100%}`;
  zip.folder('OEBPS').file('styles.css', css);

  // Build XHTML items: front matter, chapters, about
  const manifestItems = [];
  const spineItems = [];

  // front: titlepage
  const titleXhtml = `<?xml version="1.0" encoding="utf-8"?>\n<html xmlns="http://www.w3.org/1999/xhtml"><head><title>${escapeXml(title)}</title><link href="styles.css" rel="stylesheet" type="text/css"/></head><body><h1>${escapeXml(title)}</h1><h2>${escapeXml(document.getElementById('subtitle').value||'')}</h2><p>by ${escapeXml(author)}</p></body></html>`;
  zip.folder('OEBPS').file('titlepage.xhtml', titleXhtml);
  manifestItems.push({id:'titlepage', href:'titlepage.xhtml', mediaType:'application/xhtml+xml'});
  spineItems.push('titlepage');

  // intro
  const introXhtml = `<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Introduction</title><link href="styles.css" rel="stylesheet" type="text/css"/></head><body><h2>Introduction</h2><p>Generated preview from Pro-Ebook.</p></body></html>`;
  zip.folder('OEBPS').file('intro.xhtml', introXhtml); manifestItems.push({id:'intro', href:'intro.xhtml', mediaType:'application/xhtml+xml'}); spineItems.push('intro');

  // chapters
  for(let i=0;i<chapters.length;i++){
    const chapHtml = `<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter ${i+1}</title><link href="styles.css" rel="stylesheet" type="text/css"/></head><body><h2>${escapeXml(guessChapterTitle(chapters[i], i))}</h2>${chapters[i]}</body></html>`;
    const name = 'chapter' + (i+1) + '.xhtml';
    zip.folder('OEBPS').file(name, chapHtml);
    manifestItems.push({id:'chap' + (i+1), href:name, mediaType:'application/xhtml+xml'});
    spineItems.push('chap' + (i+1));
  }

  // conclusion
  const concl = `<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Conclusion</title><link href="styles.css" rel="stylesheet" type="text/css"/></head><body><h2>Conclusion</h2><p>Thanks for using Pro-Ebook.</p></body></html>`;
  zip.folder('OEBPS').file('conclusion.xhtml', concl);
  manifestItems.push({id:'conclusion', href:'conclusion.xhtml', mediaType:'application/xhtml+xml'});
  spineItems.push('conclusion');

  // images: include uploaded images into OEBPS/Images
  if(images.length>0){
    const imgFolder = zip.folder('OEBPS').folder('Images');
    for(let i=0;i<images.length;i++){
      const f = images[i].file;
      // read as blob and add
      const blob = await fileToArrayBuffer(f);
      imgFolder.file('image' + (i+1) + '.' + getExt(f.name), blob);
      manifestItems.push({id:'img' + (i+1), href:'Images/image'+(i+1)+'.'+getExt(f.name), mediaType:f.type});
    }
  }

  // content.opf (manifest + spine)
  let manifestStr = '', spineStr = '';
  manifestItems.forEach(it => { manifestStr += `<item id="${it.id}" href="${it.href}" media-type="${it.mediaType}"/>`});
  spineItems.forEach(id => { spineStr += `<itemref idref="${id}"/>`});
  const opf = `<?xml version="1.0" encoding="utf-8"?>\n<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="bookid" version="2.0">\n  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">\n    <dc:title>${escapeXml(title)}</dc:title>\n    <dc:creator>${escapeXml(author)}</dc:creator>\n    <dc:language>en</dc:language>\n    <dc:identifier id="bookid">${id}</dc:identifier>\n  </metadata>\n  <manifest>\n    ${manifestStr}\n  </manifest>\n  <spine toc="ncx">\n    ${spineStr}\n  </spine>\n</package>`;
  zip.folder('OEBPS').file('content.opf', opf);

  // toc.ncx minimal
  let navMap = '';
  let playOrder = 1;
  const navItems = [{id:'titlepage', title:title, href:'titlepage.xhtml'}, {id:'intro', title:'Introduction', href:'intro.xhtml'}];
  chapters.forEach((c,i)=>navItems.push({id:'chap' + (i+1), title:guessChapterTitle(c,i), href:'chapter' + (i+1) + '.xhtml'}));
  navItems.push({id:'conclusion', title:'Conclusion', href:'conclusion.xhtml'});
  navItems.forEach(n => { navMap += `<navPoint id="${n.id}" playOrder="${playOrder++}"><navLabel><text>${escapeXml(n.title)}</text></navLabel><content src="${n.href}"/></navPoint>`});
  const ncx = `<?xml version="1.0" encoding="UTF-8"?>\n<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">\n  <head></head>\n  <docTitle><text>${escapeXml(title)}</text></docTitle>\n  <navMap>\n    ${navMap}\n  </navMap>\n</ncx>`;
  zip.folder('OEBPS').file('toc.ncx', ncx);

  // generate blob and save as .epub
  const content = await zip.generateAsync({type:'blob', mimeType:'application/epub+zip'});
  saveAs(content, (title.replace(/\s+/g,'_') || 'book') + '.epub');
});

/* helper to convert file->arrayBuffer */
function fileToArrayBuffer(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsArrayBuffer(file); }); }
function getExt(name){ return (name.split('.').pop()||'bin').toLowerCase(); }
function escapeXml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* helpers */
function hexToRgb(hex){ hex = hex.replace('#',''); if(hex.length===3) hex = hex.split('').map(h=>h+h).join(''); const num=parseInt(hex,16); return {r:(num>>16)&255,g:(num>>8)&255,b:num&255}; }
function rgbToHex(r,g,b){ return '#'+[r,g,b].map(n=>n.toString(16).padStart(2,'0')).join(''); }

/* Init */
applyCategory();
updatePreview();

/* Update preview button */
document.getElementById('updateBtn').addEventListener('click', updatePreview);
</script>
</body>
</html>            gap: 20px;
            margin-bottom: 30px;
        }

        .template-card {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }

        .template-card:hover {
            border-color: var(--color-primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139, 71, 137, 0.2);
        }

        .template-card.active {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, rgba(139, 71, 137, 0.1) 0%, rgba(212, 163, 115, 0.1) 100%);
        }

        .template-card h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--color-dark);
        }

        .template-card p {
            font-size: 12px;
            color: #666;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-highlight) 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(139, 71, 137, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 71, 137, 0.4);
        }

        .btn-secondary {
            background: var(--color-accent);
            color: white;
            box-shadow: 0 4px 20px rgba(47, 93, 98, 0.3);
        }

        .btn-secondary:hover {
            background: #254851;
            transform: translateY(-2px);
        }

        .btn-add {
            background: var(--color-secondary);
            color: white;
            box-shadow: 0 4px 20px rgba(212, 163, 115, 0.3);
        }

        .btn-add:hover {
            background: #c19563;
            transform: translateY(-2px);
        }

        .preview-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .page {
            width: 600px;
            height: 750px;
            background: white;
            box-shadow: 0 15px 60px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            page-break-after: always;
        }

        /* TEMPLATE 1: ETHEREAL GRADIENT */
        .template-ethereal .cover {
            background: linear-gradient(135deg, #8b4789 0%, #d4a373 50%, #2f5d62 100%);
            padding: 80px 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .template-ethereal .cover::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.3; }
            50% { transform: translate(-20px, -20px) scale(1.2); opacity: 0.6; }
        }

        .template-ethereal .cover h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 68px;
            font-weight: 700;
            color: white;
            line-height: 1.1;
            margin-bottom: 30px;
            text-shadow: 2px 4px 8px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .template-ethereal .cover .subtitle {
            font-family: 'Crimson Text', serif;
            font-size: 24px;
            font-weight: 400;
            color: rgba(255,255,255,0.95);
            margin-bottom: 50px;
            font-style: italic;
            position: relative;
            z-index: 1;
        }

        .template-ethereal .cover .author {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-secondary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: auto;
            position: relative;
            z-index: 1;
        }

        .template-ethereal .divider {
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, transparent, white, transparent);
            margin: 25px 0;
            position: relative;
            z-index: 1;
        }

        /* TEMPLATE 2: ARCHITECTURAL */
        .template-architectural .cover {
            background: #1f2421;
            padding: 80px 60px;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .template-architectural .cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 50%, var(--color-accent) 100%);
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
        }

        .template-architectural .cover::after {
            content: '';
            position: absolute;
            top: 50px;
            left: 50px;
            right: 50px;
            bottom: 50px;
            border: 1px solid rgba(212, 163, 115, 0.3);
        }

        .template-architectural .cover h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 72px;
            font-weight: 800;
            color: white;
            line-height: 0.9;
            letter-spacing: -2px;
            text-transform: uppercase;
            position: relative;
            z-index: 1;
        }

        .template-architectural .cover .subtitle {
            font-family: 'Crimson Text', serif;
            font-size: 20px;
            color: var(--color-secondary);
            max-width: 400px;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .template-architectural .cover .author {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-secondary);
            text-transform: uppercase;
            letter-spacing: 4px;
            position: relative;
            z-index: 1;
        }

        /* TEMPLATE 3: ORGANIC FLOW */
        .template-organic .cover {
            background: linear-gradient(135deg, #c1666b 0%, #8b4789 100%);
            padding: 80px 60px;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .template-organic .wave {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background: radial-gradient(circle at 30% 50%, rgba(212, 163, 115, 0.3) 0%, transparent 50%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .template-organic .cover h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 64px;
            font-weight: 700;
            color: white;
            line-height: 1.2;
            position: relative;
            z-index: 1;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .template-organic .cover .subtitle {
            font-family: 'Crimson Text', serif;
            font-size: 22px;
            color: rgba(255,255,255,0.9);
            margin-top: 30px;
            font-style: italic;
            position: relative;
            z-index: 1;
        }

        .template-organic .cover .author {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-secondary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 60px;
            position: relative;
            z-index: 1;
        }

        /* Content Pages */
        .content-page {
            padding: 70px 60px;
            background: var(--color-light);
        }

        .content-page h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 44px;
            color: var(--color-primary);
            margin-bottom: 30px;
            font-weight: 700;
        }

        .content-page h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 22px;
            color: var(--color-accent);
            margin: 35px 0 18px 0;
            font-weight: 700;
        }

        .content-page p {
            font-family: 'Crimson Text', serif;
            font-size: 17px;
            line-height: 1.9;
            color: #333;
            margin-bottom: 20px;
        }

        .content-page ul {
            margin: 20px 0 20px 30px;
        }

        .content-page li {
            font-family: 'Crimson Text', serif;
            font-size: 17px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 12px;
        }

        .page-number {
            position: absolute;
            bottom: 40px;
            right: 60px;
            font-size: 14px;
            color: var(--color-secondary);
            font-weight: 600;
        }

        .toc-page {
            padding: 70px 60px;
            background: var(--color-light);
        }

        .toc-page h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 52px;
            color: var(--color-primary);
            margin-bottom: 50px;
            text-align: center;
            font-weight: 700;
        }

        .toc-item {
            display: flex;
            justify-content: space-between;
            padding: 18px 0;
            border-bottom: 1px solid rgba(139, 71, 137, 0.2);
            font-family: 'Crimson Text', serif;
            font-size: 18px;
            color: #333;
        }

        .toc-dots {
            flex: 1;
            border-bottom: 2px dotted rgba(139, 71, 137, 0.3);
            margin: 0 15px 5px 15px;
        }

        /* Print styles */
        @media print {
            body {
                background: white !important;
                padding: 0;
            }
            .app-header, .control-panel {
                display: none !important;
            }
            .page {
                box-shadow: none;
                margin: 0;
                width: 100%;
                height: 100vh;
                page-break-after: always;
                border-radius: 0;
            }
            
            /* Force print colors */
            .template-ethereal .cover,
            .template-architectural .cover,
            .template-organic .cover,
            .template-architectural .cover::before {
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            * {
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
        }

        @page {
            size: A4;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1>Professional Ebook Creator</h1>
            <p>Design & Deploy Beautiful Ebooks</p>
        </div>

        <div class="control-panel">
            <div class="input-group" style="margin-bottom: 30px;">
                <label>Select Your Template Style</label>
                <div class="template-selector" id="templateSelector">
                    <div class="template-card active" data-template="ethereal">
                        <h3>Ethereal Gradient</h3>
                        <p>Flowing multi-tone design</p>
                    </div>
                    <div class="template-card" data-template="architectural">
                        <h3>Architectural</h3>
                        <p>Bold geometric structure</p>
                    </div>
                    <div class="template-card" data-template="organic">
                        <h3>Organic Flow</h3>
                        <p>Dynamic animated waves</p>
                    </div>
                </div>
            </div>

            <div class="control-grid">
                <div class="input-group">
                    <label>Book Title</label>
                    <input type="text" id="bookTitle" value="The Renaissance Mind">
                </div>
                <div class="input-group">
                    <label>Subtitle</label>
                    <input type="text" id="subtitle" value="Cultivating Wisdom in the Modern Age">
                </div>
                <div class="input-group">
                    <label>Author Name</label>
                    <input type="text" id="authorName" value="Dr. Sophia Montenegro">
                </div>
                <div class="input-group">
                    <label>Chapter 1 Title</label>
                    <input type="text" id="chapter1" value="The Foundation of Thought">
                </div>
                <div class="input-group">
                    <label>Chapter 2 Title</label>
                    <input type="text" id="chapter2" value="Patterns of Innovation">
                </div>
                <div class="input-group">
                    <label>Chapter 3 Title</label>
                    <input type="text" id="chapter3" value="The Art of Synthesis">
                </div>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <label>Introduction Text (Edit as needed)</label>
                <textarea id="introText">Welcome to a transformative exploration of intellectual depth and creative thinking. This book represents years of research into how the greatest minds throughout history have approached learning, creativity, and problem-solving. Through these pages, you'll discover timeless principles that remain remarkably relevant in our rapidly evolving world.</textarea>
            </div>

            <div class="button-group" style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="updatePreview()">Update Preview</button>
                <button class="btn btn-secondary" onclick="downloadPDF()">Download as PDF</button>
                <button class="btn btn-add" onclick="addNewPage()">+ Add Custom Page</button>
            </div>
        </div>

        <div class="preview-container" id="previewContainer">
            <!-- Pages will be generated here -->
        </div>
    </div>

    <script>
        let currentTemplate = 'ethereal';
        let customPages = 0;

        // Template selection
        document.querySelectorAll('.template-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                currentTemplate = this.dataset.template;
                updatePreview();
            });
        });

        function updatePreview() {
            const title = document.getElementById('bookTitle').value;
            const subtitle = document.getElementById('subtitle').value;
            const author = document.getElementById('authorName').value;
            const chapter1 = document.getElementById('chapter1').value;
            const chapter2 = document.getElementById('chapter2').value;
            const chapter3 = document.getElementById('chapter3').value;
            const introText = document.getElementById('introText').value;

            const container = document.getElementById('previewContainer');
            
            // Keep existing custom pages
            const existingCustomPages = container.querySelectorAll('.custom-page');
            const customPagesHTML = Array.from(existingCustomPages).map(p => p.outerHTML).join('');
            
            container.innerHTML = `
                <!-- Cover Page -->
                <div class="page template-${currentTemplate}">
                    <div class="cover">
                        ${currentTemplate === 'organic' ? '<div class="wave"></div>' : ''}
                        <h1>${title}</h1>
                        ${currentTemplate === 'ethereal' ? '<div class="divider"></div>' : ''}
                        <div class="subtitle">${subtitle}</div>
                        ${currentTemplate === 'ethereal' ? '<div class="divider"></div>' : ''}
                        <div class="author">${author}</div>
                    </div>
                </div>

                <!-- Table of Contents -->
                <div class="page">
                    <div class="toc-page">
                        <h2>Contents</h2>
                        <div class="toc-item">
                            <span>Introduction</span>
                            <div class="toc-dots"></div>
                            <span>3</span>
                        </div>
                        <div class="toc-item">
                            <span>Chapter 1: ${chapter1}</span>
                            <div class="toc-dots"></div>
                            <span>4</span>
                        </div>
                        <div class="toc-item">
                            <span>Chapter 2: ${chapter2}</span>
                            <div class="toc-dots"></div>
                            <span>5</span>
                        </div>
                        <div class="toc-item">
                            <span>Chapter 3: ${chapter3}</span>
                            <div class="toc-dots"></div>
                            <span>6</span>
                        </div>
                        <div class="toc-item">
                            <span>Conclusion</span>
                            <div class="toc-dots"></div>
                            <span>7</span>
                        </div>
                    </div>
                </div>

                <!-- Introduction Page -->
                <div class="page">
                    <div class="content-page">
                        <h2>Introduction</h2>
                        <p>${introText}</p>
                        <p>The journey we embark upon together requires both intellectual curiosity and practical wisdom. These are not abstract concepts but living principles that can transform how we approach every aspect of our lives.</p>
                        <h3>What You Will Discover</h3>
                        <ul>
                            <li>Timeless frameworks for creative problem-solving</li>
                            <li>Methods for cultivating deeper understanding</li>
                            <li>Strategies for synthesizing diverse knowledge</li>
                            <li>Practices for sustained intellectual growth</li>
                        </ul>
                        <div class="page-number">3</div>
                    </div>
                </div>

                <!-- Chapter 1 -->
                <div class="page">
                    <div class="content-page">
                        <h2>Chapter One</h2>
                        <h3>${chapter1}</h3>
                        <p>Every great intellectual journey begins with establishing a solid foundation. The principles we explore here have been tested across centuries and cultures, proving their enduring value and universal applicability.</p>
                        <p>Consider the great thinkers throughout history. What united them was not superior intelligence alone, but rather a systematic approach to understanding the world. They developed mental frameworks that allowed them to see patterns invisible to others.</p>
                        <p>This chapter introduces you to these foundational frameworks. We'll examine how they were developed, why they work, and most importantly, how you can apply them immediately in your own thinking.</p>
                        <h3>The Core Principles</h3>
                        <p>At the heart of all exceptional thinking lie several key principles that transcend specific domains or disciplines. These principles form the bedrock upon which all advanced intellectual work is built.</p>
                        <div class="page-number">4</div>
                    </div>
                </div>

                <!-- Chapter 2 -->
                <div class="page">
                    <div class="content-page">
                        <h2>Chapter Two</h2>
                        <h3>${chapter2}</h3>
                        <p>Innovation is not random—it follows patterns. Once you learn to recognize these patterns, you gain the ability to not only understand innovation but to create it yourself. This chapter reveals the hidden structures behind breakthrough thinking.</p>
                        <p>Throughout history, the greatest innovations have emerged from the intersection of seemingly unrelated fields. The Renaissance produced unprecedented creativity precisely because its thinkers refused to be confined by traditional boundaries.</p>
                        <h3>Recognizing Opportunity</h3>
                        <p>Innovation begins with the ability to see what others miss. This requires training your mind to look beyond the obvious, to question assumptions, and to explore connections that initially seem improbable.</p>
                        <ul>
                            <li>Learn to identify weak signals before they become obvious trends</li>
                            <li>Develop your capacity for analogical thinking</li>
                            <li>Cultivate intellectual courage to pursue unconventional ideas</li>
                        </ul>
                        <div class="page-number">5</div>
                    </div>
                </div>

                <!-- Chapter 3 -->
                <div class="page">
                    <div class="content-page">
                        <h2>Chapter Three</h2>
                        <h3>${chapter3}</h3>
                        <p>Synthesis represents the highest form of intellectual work—the ability to integrate diverse knowledge into coherent new understanding. This is where true wisdom emerges, transcending mere accumulation of information.</p>
                        <p>The modern world suffers from fragmentation. Knowledge is divided into increasingly narrow specializations, losing sight of the bigger picture. Synthesis reverses this trend, reconnecting what has been artificially separated.</p>
                        <h3>The Practice of Integration</h3>
                        <p>Synthesis is both an art and a skill. While some possess natural talent for seeing connections, everyone can develop this capacity through deliberate practice and proper guidance.</p>
                        <p>Begin by exposing yourself to diverse fields of knowledge. Read broadly. Engage with ideas far removed from your expertise. Allow unexpected connections to emerge naturally from this rich intellectual ecosystem you're cultivating.</p>
                        <div class="page-number">6</div>
                    </div>
                </div>

                <!-- Conclusion -->
                <div class="page">
                    <div class="content-page">
                        <h2>Conclusion</h2>
                        <p>We have journeyed through the essential elements of exceptional thinking—from establishing foundations to recognizing patterns to achieving synthesis. Each concept builds upon the last, creating an integrated approach to intellectual development.</p>
                        <p>But understanding these principles intellectually is merely the beginning. True mastery comes only through consistent application. The frameworks presented here must become living tools in your daily thinking, not abstract theories to be admired from afar.</p>
                        <h3>Your Path Forward</h3>
                        <p>Begin today. Choose one principle from this book and commit to applying it consistently for the next month. Notice how it changes your thinking, your work, and your understanding of the world around you.</p>
                        <p>Remember that intellectual development is not a destination but a lifelong journey. The greatest minds never stop learning, never stop questioning, never stop growing. Join them in this noble pursuit.</p>
                        <p>The Renaissance mind is not limited to a historical period—it represents a timeless approach to thinking that remains as relevant and powerful today as it was centuries ago. Cultivate it in yourself, and you will discover capabilities you never knew you possessed.</p>
                        <div class="page-number">7</div>
                    </div>
                </div>
                
                ${customPagesHTML}
            `;
            
            // Re-attach event listeners to custom pages
            attachCustomPageListeners();
        }

        function downloadPDF() {
            window.print();
        }

        function addNewPage() {
            customPages++;
            const container = document.getElementById('previewContainer');
            const newPage = document.createElement('div');
            newPage.className = 'page custom-page';
            newPage.innerHTML = `
                <div class="content-page" contenteditable="true" style="cursor: text;">
                    <h2 contenteditable="true">Custom Page ${customPages}</h2>
                    <p contenteditable="true">Click here to edit this content. You can change the title above and add your own text here. This page will be included when you download the PDF.</p>
                    <p contenteditable="true">Add more paragraphs, format your text, and create the perfect custom content for your ebook.</p>
                    <div class="page-number">${7 + customPages}</div>
                </div>
            `;
            container.appendChild(newPage);
            
            // Make the new page editable immediately
            const contentDiv = newPage.querySelector('.content-page');
            contentDiv.focus();
            
            // Show success message
            alert(`Custom page ${customPages} added! Click on the text to edit it directly.`);
        }

        function attachCustomPageListeners() {
            document.querySelectorAll('.custom-page .content-page').forEach(page => {
                page.setAttribute            gap: 20px;
            margin-bottom: 30px;
        }

        .template-card {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }

        .template-card:hover {
            border-color: var(--color-primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139, 71, 137, 0.2);
        }

        .template-card.active {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, rgba(139, 71, 137, 0.1) 0%, rgba(212, 163, 115, 0.1) 100%);
        }

        .template-card h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--color-dark);
        }

        .template-card p {
            font-size: 12px;
            color: #666;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-highlight) 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(139, 71, 137, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 71, 137, 0.4);
        }

        .btn-secondary {
            background: var(--color-accent);
            color: white;
            box-shadow: 0 4px 20px rgba(47, 93, 98, 0.3);
        }

        .btn-secondary:hover {
            background: #254851;
            transform: translateY(-2px);
        }

        .btn-add {
            background: var(--color-secondary);
            color: white;
            box-shadow: 0 4px 20px rgba(212, 163, 115, 0.3);
        }

        .btn-add:hover {
            background: #c19563;
            transform: translateY(-2px);
        }

        .navigation-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 14px 28px;
            background: white;
            border: 3px solid var(--color-primary);
            color: var(--color-primary);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn:hover {
            background: var(--color-primary);
            color: white;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-indicator {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            color: var(--color-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            position: relative;
        }

        .page {
            width: 600px;
            height: 750px;
            background: white;
            box-shadow: 0 15px 60px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            page-break-after: always;
            display: none;
        }

        .page.active {
            display: block;
        }

        /* TEMPLATE 1: ETHEREAL GRADIENT */
        .template-ethereal .cover {
            background: linear-gradient(135deg, #8b4789 0%, #d4a373 50%, #2f5d62 100%);
            padding: 80px 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .template-ethereal .cover::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.3; }
            50% { transform: translate(-20px, -20px) scale(1.2); opacity: 0.6; }
        }

        .template-ethereal .cover h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 68px;
            font-weight: 700;
            color: white;
            line-height: 1.1;
            margin-bottom: 30px;
            text-shadow: 2px 4px 8px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .template-ethereal .cover .subtitle {
            font-family: 'Crimson Text', serif;
            font-size: 24px;
            font-weight: 400;
            color: rgba(255,255,255,0.95);
            margin-bottom: 50px;
            font-style: italic;
            position: relative;
            z-index: 1;
        }

        .template-ethereal .cover .author {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-secondary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: auto;
            position: relative;
            z-index: 1;
        }

        .template-ethereal .divider {
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, transparent, white, transparent);
            margin: 25px 0;
            position: relative;
            z-index: 1;
        }

        /* TEMPLATE 2: ARCHITECTURAL */
        .template-architectural .cover {
            background: #1f2421;
            padding: 80px 60px;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .template-architectural .cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 50%, var(--color-accent) 100%);
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
        }

        .template-architectural .cover::after {
            content: '';
            position: absolute;
            top: 50px;
            left: 50px;
            right: 50px;
            bottom: 50px;
            border: 1px solid rgba(212, 163, 115, 0.3);
        }

        .template-architectural .cover h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 72px;
            font-weight: 800;
            color: white;
            line-height: 0.9;
            letter-spacing: -2px;
            text-transform: uppercase;
            position: relative;
            z-index: 1;
        }

        .template-architectural .cover .subtitle {
            font-family: 'Crimson Text', serif;
            font-size: 20px;
            color: var(--color-secondary);
            max-width: 400px;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .template-architectural .cover .author {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-secondary);
            text-transform: uppercase;
            letter-spacing: 4px;
            position: relative;
            z-index: 1;
        }

        /* TEMPLATE 3: ORGANIC FLOW */
        .template-organic .cover {
            background: linear-gradient(135deg, #c1666b 0%, #8b4789 100%);
            padding: 80px 60px;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .template-organic .wave {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background: radial-gradient(circle at 30% 50%, rgba(212, 163, 115, 0.3) 0%, transparent 50%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .template-organic .cover h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 64px;
            font-weight: 700;
            color: white;
            line-height: 1.2;
            position: relative;
            z-index: 1;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .template-organic .cover .subtitle {
            font-family: 'Crimson Text', serif;
            font-size: 22px;
            color: rgba(255,255,255,0.9);
            margin-top: 30px;
            font-style: italic;
            position: relative;
            z-index: 1;
        }

        .template-organic .cover .author {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-secondary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 60px;
            position: relative;
            z-index: 1;
        }

        /* Content Pages */
        .content-page {
            padding: 70px 60px;
            background: var(--color-light);
            height: 100%;
        }

        .content-page h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 44px;
            color: var(--color-primary);
            margin-bottom: 30px;
            font-weight: 700;
        }

        .content-page h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 22px;
            color: var(--color-accent);
            margin: 35px 0 18px 0;
            font-weight: 700;
        }

        .content-page p {
            font-family: 'Crimson Text', serif;
            font-size: 17px;
            line-height: 1.9;
            color: #333;
            margin-bottom: 20px;
        }

        .content-page ul {
            margin: 20px 0 20px 30px;
        }

        .content-page li {
            font-family: 'Crimson Text', serif;
            font-size: 17px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 12px;
        }

        .page-number {
            position: absolute;
            bottom: 40px;
            right: 60px;
            font-size: 14px;
            color: var(--color-secondary);
            font-weight: 600;
        }

        .toc-page {
            padding: 70px 60px;
            background: var(--color-light);
            height: 100%;
        }

        .toc-page h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 52px;
            color: var(--color-primary);
            margin-bottom: 50px;
            text-align: center;
            font-weight: 700;
        }

        .toc-item {
            display: flex;
            justify-content: space-between;
            padding: 18px 0;
            border-bottom: 1px solid rgba(139, 71, 137, 0.2);
            font-family: 'Crimson Text', serif;
            font-size: 18px;
            color: #333;
        }

        .toc-dots {
            flex: 1;
            border-bottom: 2px dotted rgba(139, 71, 137, 0.3);
            margin: 0 15px 5px 15px;
        }

        /* Print styles */
        @media print {
            body {
                background: white !important;
                padding: 0;
            }
            .app-header, .control-panel, .navigation-controls {
                display: none !important;
            }
            .page {
                box-shadow: none;
                margin: 0;
                width: 100%;
                height: 100vh;
                page-break-after: always;
                border-radius: 0;
                display: block !important;
            }
            
            .template-ethereal .cover,
            .template-architectural .cover,
            .template-organic .cover,
            .template-architectural .cover::before {
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            * {
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
        }

        @page {
            size: A4;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1>Professional Ebook Creator</h1>
            <p>Design & Deploy Beautiful Ebooks</p>
        </div>

        <div class="control-panel">
            <div class="input-group" style="margin-bottom: 30px;">
                <label>Select Your Template Style</label>
                <div class="template-selector" id="templateSelector">
                    <div class="template-card active" data-template="ethereal">
                        <h3>Ethereal Gradient</h3>
                        <p>Flowing multi-tone design</p>
                    </div>
                    <div class="template-card" data-template="architectural">
                        <h3>Architectural</h3>
                        <p>Bold geometric structure</p>
                    </div>
                    <div class="template-card" data-template="organic">
                        <h3>Organic Flow</h3>
                        <p>Dynamic animated waves</p>
                    </div>
                </div>
            </div>

            <div class="control-grid">
                <div class="input-group">
                    <label>Book Title</label>
                    <input type="text" id="bookTitle" value="The Renaissance Mind">
                </div>
                <div class="input-group">
                    <label>Subtitle</label>
                    <input type="text" id="subtitle" value="Cultivating Wisdom in the Modern Age">
                </div>
                <div class="input-group">
                    <label>Author Name</label>
                    <input type="text" id="authorName" value="Dr. Sophia Montenegro">
                </div>
                <div class="input-group">
                    <label>Chapter 1 Title</label>
                    <input type="text" id="chapter1" value="The Foundation of Thought">
                </div>
                <div class="input-group">
                    <label>Chapter 2 Title</label>
                    <input type="text" id="chapter2" value="Patterns of Innovation">
                </div>
                <div class="input-group">
                    <label>Chapter 3 Title</label>
                    <input type="text" id="chapter3" value="The Art of Synthesis">
                </div>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <label>Introduction Text (Edit as needed)</label>
                <textarea id="introText">Welcome to a transformative exploration of intellectual depth and creative thinking. This book represents years of research into how the greatest minds throughout history have approached learning, creativity, and problem-solving. Through these pages, you'll discover timeless principles that remain remarkably relevant in our rapidly evolving world.</textarea>
            </div>

            <div class="button-group" style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="updatePreview()">📝 Update Preview</button>
                <button class="btn btn-secondary" onclick="downloadPDF()">📥 Download PDF</button>
                <button class="btn btn-add" onclick="addNewPage()">➕ Add Custom Page</button>
            </div>
        </div>

        <div class="navigation-controls">
            <button class="nav-btn" onclick="previousPage()" id="prevBtn">
                ◀ Previous
            </button>
            <div class="page-indicator">
                <span>Page <span id="currentPage">1</span> of <span id="totalPages">8</span></span>
            </div>
            <button class="nav-btn" onclick="nextPage()" id="nextBtn">
                Next ▶
            </button>
        </div>

        <div class="preview-container" id="previewContainer">
            <!-- Pages will be generated here -->
        </div>
    </div>

    <script>
        let currentTemplate = 'ethereal';
        let customPages = 0;
        let currentPageIndex = 0;
        let totalPagesCount = 8;

        // Template selection
        document.querySelectorAll('.template-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                currentTemplate = this.dataset.template;
                updatePreview();
            });
        });

        function updatePreview() {
            const title = document.getElementById('bookTitle').value;
            const subtitle = document.getElementById('subtitle').value;
            const author = document.getElementById('authorName').value;
            const chapter1 = document.getElementById('chapter1').value;
            const chapter2 = document.getElementById('chapter2').value;
            const chapter3 = document.getElementById('chapter3').value;
            const introText = document.getElementById('introText').value;

            const container = document.getElementById('previewContainer');
            
            container.innerHTML = `
                <!-- Cover Page -->
                <div class="page template-${currentTemplate} active" data-page="0">
                    <div class="cover">
                        ${currentTemplate === 'organic' ? '<div class="wave"></div>' : ''}
                        <h1>${title}</h1>
                        ${currentTemplate === 'ethereal' ? '<div class="divider"></div>' : ''}
                        <div class="subtitle">${subtitle}</div>
                        ${currentTemplate === 'ethereal' ? '<div class="divider"></div>' : ''}
                        <div class="author">${author}</div>
                    </div>
                </div>

                <!-- Table of Contents -->
                <div class="page" data-page="1">
                    <div class="toc-page">
                        <h2>Contents</h2>
                        <div class="toc-item">
                            <span>Introduction</span>
                            <div class="toc-dots"></div>
                            <span>3</span>
                        </div>
                        <div class="toc-item">
                            <span>Chapter 1: ${chapter1}</span>
                            <div class="toc-dots"></div>
                            <span>4</span>
                        </div>
                        <div class="toc-item">
                            <span>Chapter 2: ${chapter2}</span>
                            <div class="toc-dots"></div>
                            <span>5</span>
                        </div>
                        <div class="toc-item">
                            <span>Chapter 3: ${chapter3}</span>
                            <div class="toc-dots"></div>
                            <span>6</span>
                        </div>
                        <div class="toc-item">
                            <span>Conclusion</span>
                            <div class="toc-dots"></div>
                            <span>7</span>
                        </div>
                    </div>
                </div>

                <!-- Introduction Page -->
                <div class="page" data-page="2">
                    <div class="content-page">
                        <h2>Introduction</h2>
                        <p>${introText}</p>
                        <p>The journey we embark upon together requires both intellectual curiosity and practical wisdom. These are not abstract concepts but living principles that can transform how we approach every aspect of our lives.</p>
                        <h3>What You Will Discover</h3>
                        <ul>
                            <li>Timeless frameworks for creative problem-solving</li>
                            <li>Methods for cultivating deeper understanding</li>
                            <li>Strategies for synthesizing diverse knowledge</li>
                            <li>Practices for sustained intellectual growth</li>
                        </ul>
                        <div class="page-number">3</div>
                    </div>
                </div>

                <!-- Chapter 1 -->
                <div class="page" data-page="3">
                    <div class="content-page">
                        <h2>Chapter One</h2>
                        <h3>${chapter1}</h3>
                        <p>Every great intellectual journey begins with establishing a solid foundation. The principles we explore here have been tested across centuries and cultures, proving their enduring value and universal applicability.</p>
                        <p>Consider the great thinkers throughout history. What united them was not superior intelligence alone, but rather a systematic approach to understanding the world. They developed mental frameworks that allowed them to see patterns invisible to others.</p>
                        <p>This chapter introduces you to these foundational frameworks. We'll examine how they were developed, why they work, and most importantly, how you can apply them immediately in your own thinking.</p>
                        <h3>The Core Principles</h3>
                        <p>At the heart of all exceptional thinking lie several key principles that transcend specific domains or disciplines. These principles form the bedrock upon which all advanced intellectual work is built.</p>
                        <div class="page-number">4</div>
                    </div>
                </div>

                <!-- Chapter 2 -->
                <div class="page" data-page="4">
                    <div class="content-page">
                        <h2>Chapter Two</h2>
                        <h3>${chapter2}</h3>
                        <p>Innovation is not random—it follows patterns. Once you learn to recognize these patterns, you gain the ability to not only understand innovation but to create it yourself. This chapter reveals the hidden structures behind breakthrough thinking.</p>
                        <p>Throughout history, the greatest innovations have emerged from the intersection of seemingly unrelated fields. The Renaissance produced unprecedented creativity precisely because its thinkers refused to be confined by traditional boundaries.</p>
                        <h3>Recognizing Opportunity</h3>
                        <p>Innovation begins with the ability to see what others miss. This requires training your mind to look beyond the obvious, to question assumptions, and to explore connections that initially seem improbable.</p>
                        <ul>
                            <li>Learn to identify weak signals before they become obvious trends</li>
                            <li>Develop your capacity for analogical thinking</li>
                            <li>Cultivate intellectual courage to pursue unconventional ideas</li>
                        </ul>
                        <div class="page-number">5</div>
                    </div>
                </div>

                <!-- Chapter 3 -->
                <div class="page" data-page="5">
                    <div class="content-page">
                        <h2>Chapter Three</h2>
                        <h3>${chapter3}</h3>
                        <p>Synthesis represents the highest form of intellectual work—the ability to integrate diverse knowledge into coherent new understanding. This is where true wisdom emerges, transcending mere accumulation of information.</p>
                        <p>The modern world suffers from fragmentation. Knowledge is divided into increasingly narrow specializations, losing sight of the bigger picture. Synthesis reverses this trend, reconnecting what has been artificially separated.</p>
                        <h3>The Practice of Integration</h3>
                        <p>Synthesis is both an art and a skill. While some possess natural talent for seeing connections, everyone can develop this capacity through deliberate practice and proper guidance.</p>
                        <p>Begin by exposing yourself to diverse fields of knowledge. Read broadly. Engage with ideas far removed from your expertise. Allow unexpected connections to emerge naturally from this rich intellectual ecosystem you're cultivating.</p>
                        <div class="page-number">6</div>
                    </div>
                </div>

                <!-- Conclusion -->
                <div class="page" data-page="6">
                    <div class="content-page">
                        <h2>Conclusion</h2>
                        <p>We have journeyed through the essential elements of exceptional thinking—from establishing foundations to recognizing patterns to achieving synthesis. Each concept builds upon the last, creating an integrated approach to intellectual development.</p>
                        <p>But understanding these principles intellectually is merely the beginning. True mastery comes only through consistent application. The frameworks presented here must become living tools in your daily thinking, not abstract theories to be admired from afar.</p>
